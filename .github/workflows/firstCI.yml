name: Build and Test storage engine

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y curl bzip2 ninja-build libudev-dev libboost-dev libnuma-dev libtirpc-dev
          sudo pip3 install -r tests/pytest/requirements.txt

      - name: Prepare Boost (1.77.0)
        run: |
          set -eux
          mkdir -p boost
          curl -fsSL https://archives.boost.io/release/1.77.0/source/boost_1_77_0.tar.bz2 -o boost/boost_1_77_0.tar.bz2
          echo "fc9f85fc030e233142908241af7a846e60630aa7388de9a5fafb1f3a26840854  boost/boost_1_77_0.tar.bz2" | sha256sum -c -
          tar -xjf boost/boost_1_77_0.tar.bz2 -C boost

      - name: Build
        run: |
          ln -s "$(pwd)" third_party/mysql-server/storage/lineairdb
          mkdir -p build/data
          cd build
          cmake ../third_party/mysql-server \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=1 \
            -DWITH_BUILD_ID=0 \
            -DWITH_ASAN=0 \
            -DCMAKE_BUILD_TYPE=Debug \
            -DDOWNLOAD_BOOST=0 \
            -DWITH_BOOST=../boost/boost_1_77_0 \
            -DWITH_NDB=OFF \
            -DWITH_NDBCLUSTER_STORAGE_ENGINE=OFF \
            -DCMAKE_CXX_FLAGS="-include cstdint -Wno-error=extra-semi -Wno-error=ignored-attributes" \
            -G Ninja
          ninja ha_lineairdb_storage_engine.so -j "$(nproc)"
          ninja mysqld mysql mysqladmin -j "$(nproc)"

      - name: Start MySQL Server
        working-directory: build
        run: |
          set -euxo pipefail
          rm -rf mysql-data
          mkdir -p mysql-data
          ./bin/mysqld --no-defaults \
            --initialize-insecure \
            --datadir="$PWD/mysql-data" \
            --log-error="$PWD/mysql-data/error.log"
          ./bin/mysqld --no-defaults \
            --datadir="$PWD/mysql-data" \
            --plugin-dir="$PWD/plugin_output_directory" \
            --socket=/tmp/mysql.sock \
            --port=3307 \
            --bind-address=127.0.0.1 \
            --log-error="$PWD/mysql-data/error.log" \
            --daemonize
          ./client/mysqladmin -h127.0.0.1 -P3307 -uroot --protocol=tcp ping --wait=30
          ./client/mysql -h127.0.0.1 -P3307 -uroot -e \
            "ALTER USER 'root'@'localhost' IDENTIFIED BY 'root'; FLUSH PRIVILEGES;"

      - name: Copy into MySQL plugin directory
        working-directory: build
        run: |
          plugin_dir=$(./client/mysql -h127.0.0.1 -P3307 -uroot -proot -N -e "SHOW VARIABLES LIKE 'plugin_dir';" | awk '{print $2}')
          sudo cp plugin_output_directory/ha_lineairdb_storage_engine.so "$plugin_dir"

      - name: Setup MySQL Server
        working-directory: build
        run: |
          ./client/mysql -h127.0.0.1 -P3307 -uroot -proot -e "INSTALL PLUGIN lineairdb SONAME 'ha_lineairdb_storage_engine.so';"

      - name: Exec test scripts
        env:
          MYSQL_HOST: 127.0.0.1
          MYSQL_PORT: "3307"
          MYSQL_PWD: root
        run: |
          python3 tests/run_tests.py -c
